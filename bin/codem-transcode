#!/usr/bin/env node
const Bunyan     = require('bunyan')
const Transcoder = require('../lib/transcoder.js')
const Config     = require('../lib/config.js')
const argv       = require('minimist')(process.argv.slice(2), { alias: { c: "config", h: "help" }})

function loadConfig() {
  try {
    return new Config(argv.config)
  } catch(err) {
    printErrorAndExit(err)
  }  
}

function printErrorAndExit(error) {
  if (error instanceof SyntaxError) {
    console.log("Error: Could not parse the config file. Please check if it's a valid JSON file.")
  } else if (error.code === "ENOENT") {
    console.log("Error: Could not find the config file. Please check if it's the correct path.")
  }
  console.log(error)
  process.exit(1)
}

function printUsageAndExit() {
  console.log([
    "usage: codem-transcode [arguments]",
    "",
    "arguments:",
    "  -c --config        Specify the config file to use. Must be a valid JSON object.",
    "                     If not specified the default config will be used (listed below).",
    "  -h --help          Print this list and exit.",
    "",
    "default config:",
    "  address: '127.0.0.1'",
    "  port: 8080",
    "  logLevel: 'info'",
    "  storageBackend: { 'type': 'memory' }",
    "  slots: number of available CPU's"
  ].join('\n'))
  process.exit(1)
}

function validateArguments(argv) {
  if (argv.help)    { printUsageAndExit() }
}

// Boot script

validateArguments(argv)

const config     = loadConfig()
const logger     = Bunyan.createLogger({
  name: 'codem-transcode',
  level: config.logLevel,
  serializers: { req: Bunyan.stdSerializers.req, res: Bunyan.stdSerializers.res }
})
const transcoder = new Transcoder(config, logger)
transcoder.boot()