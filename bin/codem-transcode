#!/usr/bin/env node
const Transcoder = require('../lib/transcoder.js')
const Config     = require('../lib/config.js')
const argv       = require('minimist')(process.argv.slice(2), { alias: { c: "config", h: "help" }})

function printErrorAndExit(error) {
  if (error instanceof SyntaxError) {
    console.log("Error: Could not parse the config file. Please check if it's a valid JSON file.")
  } else if (error.code === "ENOENT") {
    console.log("Error: Could not find the config file. Please check if it's the correct path.")
  }
  console.log(error)
  process.exit(1)
}

function printUsageAndExit() {
  console.log([
    "usage: codem-transcode [arguments]",
    "",
    "arguments:",
    "  -c --config        Specify the config file to use. Must be a valid JSON object.",
    "                     If not specified the default config will be used (listed below).",
    "  -h --help          Print this list and exit.",
    "",
    "default config:",
    "  port: 8080"
  ].join('\n'))
  process.exit(1)
}

function validateArguments(argv) {
  if (argv.help)    { printUsageAndExit() }
}

// Boot script

validateArguments(argv)

const config = (() => {
  try {
    return new Config(argv.config)
  } catch(err) {
    printErrorAndExit(err)
  }  
})()

const transcoder = new Transcoder(config)
transcoder.boot()